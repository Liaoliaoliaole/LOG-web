<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="shortcut icon" type="image/x-icon" href="../art/rpi_logo.ico" />
<title>Network Configuration</title>
<style>
td.bold {
    font-weight: bold;
}
input.global_style{
	width: 3em;
}
</style>
</head>
<body>
<table style="margin:auto">
  <tr>
    <th colspan="2">Machine Identifier</th>
  </tr>
  <tr>
    <td>Hostname</td>
    <td>
		<input style="width:20;" type="text" id="hostname">
	</td>
  </tr>
  <tr>
    <th colspan="2">Internet Configuration</th>
  </tr>
  <tr>
	<td>
		<select id="ip_conf">
			<option value="Static">Static</option>
			<option value="dhcp">DHCP</option>
		</select>
	</td>
  </tr>
  <tr>
    <td>Network IP</td>
    <td>
		<input class="global_style" type="number" name="ip" min="0" max="255">.
		<input class="global_style" type="number" name="ip" min="0" max="255">.
		<input class="global_style" type="number" name="ip" min="0" max="255">.
		<input class="global_style" type="number" name="ip" min="0" max="255">/
		<input class="global_style" type="number" name="mask" min="0" max="32">
	</td>
  </tr>
  <tr>
    <td>Default Gateway</td>
    <td>
		<input class="global_style" type="number" name="gateway" min="0" max="255">.
		<input class="global_style" type="number" name="gateway" min="0" max="255">.
		<input class="global_style" type="number" name="gateway" min="0" max="255">.
		<input class="global_style" type="number" name="gateway" min="0" max="255">
	</td>
  </tr>
  <tr>
    <th colspan="2">NTP Configuration</th>
  </tr>
  <tr>
    <td>IP address</td>
     <td>
		<input class="global_style" type="number" name="ntp" min="0" max="255">.
		<input class="global_style" type="number" name="ntp" min="0" max="255">.
		<input class="global_style" type="number" name="ntp" min="0" max="255">.
		<input class="global_style" type="number" name="ntp" min="0" max="255">
	</td>
  </tr>
  <tr>
    <td><input id="default" type="button" value="load Default" onclick="default_config()"></td>
    <td style="text-align: right;"><input id="Save" type="button" value="Save and Reboot" onclick="Send_to_rpi()"></td>
  </tr>
</table>
<script src='../morfeas_ecma/common.js'></script>
<script>
/*
@licstart  The following is the entire license notice for the
JavaScript code in this page.

Copyright (C) 12019-12020  Sam Harry Tzavaras

The JavaScript code in this page is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU AGPL) as published by the Free Software
Foundation, either version 3 of the License, or any later version.
The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU AGPL for more details.

@licend  The above is the entire license notice
for the JavaScript code in this page.
*/
	//DOM vars
	var hostname=document.getElementById("hostname"),
		ip=document.getElementsByName("ip"),
		mask=document.getElementsByName("mask"),
	    gateway=document.getElementsByName("gateway"),
		ntp=document.getElementsByName("ntp");
	
	//Set limits
	
	//AJAX object for configuration receive and send
	var fl,xhttp = new XMLHttpRequest();
	var Request = {
		  GET: 1,
		  POST: 0
		};
	xhttp.onreadystatechange = function() 
	{
		if (this.readyState == 4 && this.status == 200) 
		{
			if(fl==Request.GET)//Get request
			{
				var config;
				if(config = JSON.parse(xhttp.responseText))
					default_config(config);
			}
		}
	};
	//Get the configuration
	fl=Request.GET;
	xhttp.open("GET", "../morfeas_php/config.php"+"?COMMAND=getCurConfig", true);
	xhttp.send();

	function default_config(config)
	{
		hostname.value = config.hostname
		for(let i=0;i<4;i++)
		{
			ip[i].max=255;ip[i].min=0;
			mask[i].max=255;mask[i].min=0;
			mask[i].max=255;mask[i].min=0;
			gateway[i].max=255;gateway[i].min=0;

			ip[i].value=config.eth_ip[i+2];
			mask[i].value=config.mask[i+2];
			gateway[i].value=config.gateway[i+2];
			if(i==1)
			{
				ip[i].min=1;
				gateway[i].min=1;
			}
		}
		/*
		for(let i=0;i<4;i++)
		{
		}
		*/
	}
	function Send_to_rpi()
	{
		const mask_val=[0,128,192,224,240,248,252,254,255];
		for(i=0;i<2;i++)
		{
			if((parseInt(ip[i].value)>parseInt(ip[i].max))
			 ||(parseInt(ip[i].value)<parseInt(ip[i].min))
			 ||(parseInt(gateway[i].value)>parseInt(gateway[i].max))
			 ||(parseInt(gateway[i].value)<parseInt(gateway[i].min))
			 ||!Number.isInteger(parseFloat(ip[i].value)))
			{
				alert("IP address or IP of default Gateway in not valid");
				return;
			}
			if((mask_val.indexOf(parseInt(mask[i].value))<0)
			 ||(parseInt(mask[1].value)>0&&parseInt(mask[0].value)!=255)
			 ||(parseInt(mask[1].value))==255)
			{
				alert("Subnet mask in not valid");
				return;
			}
		}
		if((parseInt(connections.value)>parseInt(connections.max))
		 ||(parseInt(connections.value)<parseInt(connections.min))
		 ||!Number.isInteger(parseFloat(connections.value)))
		{
			alert("Max connections number NOT Valid");
			return;
		}
		/*if((parseInt(modbus_add.value)>parseInt(modbus_add.max))
		 ||(parseInt(modbus_add.value)<parseInt(modbus_add.min))
		 ||!Number.isInteger(parseFloat(modbus_add.value)))
		{
			alert("ModBus Address NOT in Range (6..255)");
			return;
		}*/
		if((parseInt(modbus_port.value)>parseInt(modbus_port.max))
		 ||(parseInt(modbus_port.value)<parseInt(modbus_port.min))
		 || modbus_port.value==80||!Number.isInteger(parseFloat(modbus_port.value)))
		{
			alert("ModBus Port NOT in Range");
			return;
		}
		//Send the configuration
		fl=Request.POST;
		xhttp.open("POST", "config.php", true);
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhttp.send("IP_ADD=192.168."+ip[0].value+"."+ip[1].value+"&MASK=255.255."
					+mask[0].value+"."+mask[1].value+"&GATE=192.168."+gateway[0].value
					+"."+gateway[1].value+"&PORT="+modbus_port.value+"&MAX_CONN="+connections.value+"&ADD="+modbus_add);//.value
		alert("Rpi Save configuration and Rebooting");
	}
</script>
</body>
</html>