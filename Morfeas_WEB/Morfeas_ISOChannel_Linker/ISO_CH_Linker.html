<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link href="../External_components/tabulator/dist/css/tabulator.min.css" rel="stylesheet">
<link rel="shortcut icon" type="image/x-icon" href="/art/Morfeas_logo_yellow.ico">
<title>Morfeas WEB ISOChannels Linker</title>
</head>
<body>
<div id="opcua_config_table"></div>
<footer id="footer">
	<div style="float:left;">
		Author: Sam Harry Tzavaras &#169; 12021-12022<br>
		<a href="../LICENSE">License: AGPLv3</a>
	</div>
</footer>
</body>
<script src="../External_components/jquery/dist/jquery.min.js"></script>
<script src="../External_components/sparkline/dist/jquery.sparkline.min.js"></script>
<script src="../External_components/tabulator/dist/js/tabulator.min.js"></script>
<script src="../External_components/moment/dist/moment.min.js"></script>
<script src='../morfeas_ecma/common.js'></script>
<script src='../morfeas_ecma/morfeas_web_if.js'></script>
<script>
//@license magnet:?xt=urn:btih:0b31508aeb0634b347b8270c7bee4d411b5d4109&dn=agpl-3.0.txt AGPL-v3.0
/*
@licstart  The following is the entire license notice for the
JavaScript code in this page.

Copyright (C) 12019-12021  Sam Harry Tzavaras

The JavaScript code in this page is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU AGPL) as published by the Free Software
Foundation, either version 3 of the License, or any later version.
The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.

@licend  The above is the entire license notice
for the JavaScript code in this page.
*/
"use strict";
comp_check();
const mode_enum = {
	opcua_config: 0,
	logstats: 1
};
const GRAPH_LENGTH = 60;
//Global Vars.
var data_req=false,
	OPCUA_Config_xml_modified_flag=false,
	request_mode = mode_enum.opcua_config;

const cal_date_format_params = {
    outputFormat:"DD/MM/YYYY",
    invalidPlaceholder:"-"
};
var hist_graph_formatter = function(cell, formatterParams, onRendered){
    onRendered(function(){$(cell.getElement()).sparkline(cell.getValue(), {width:"100%", type:"line"});});
};
var opcua_config_table = new Tabulator("#opcua_config_table",
{
	height:"800px",
 	layout:"fitDataStretch",
 	responsiveLayout:"collapse",
	columns:
	[
	 	{formatter:"responsiveCollapse",  responsive:0, width:30, minWidth:30, hozAlign:"center", resizable:false, headerSort:false},
		{title:"\#", field:"id", hozAlign:"center", width:50, resizable:false, responsive:0},
		{field:"col" ,formatter:"color", resizable:false, responsive:0},
		{title:"ISOChannel", field:"iso_name", responsive:0},
		{title:"Type", field:"type", responsive:0},
	 	{title:"Connection", field:"conn", minWidth:170, responsive:0},
		{title:"Sensor status", field:"status", responsive:0},
	 	{title:"Value", field:"meas", width:80, headerSort:false, responsive:0},
	 	{title:"History", field:"graph", headerSort:false, responsive:0, formatter:hist_graph_formatter},
		{title:"Unit", field:"unit", headerSort:false, responsive:1},
		{title:"Valid until", field:"cal_date", width:80, headerSort:false, responsive:2, formatter:"datetime", formatterParams:cal_date_format_params},
		{title:"Min", field:"min", headerSort:false, responsive:3},
		{title:"Max", field:"max", headerSort:false, responsive:4},
		{title:"Description", field:"desc", headerSort:false, responsive:5},
	]
});

//AJAX response handler
var xhttp = new XMLHttpRequest();
xhttp.timeout = 2000;
xhttp.onreadystatechange = function()
{
	let status_tab=document.getElementById("status_tab"), curr_logstats;
	if (this.readyState == 4 && this.status == 200)
	{
		if(this.getResponseHeader("Content-Type")!=="application/json")
			return;
		switch(request_mode)
		{
			case mode_enum.opcua_config:
				let curr_opcua_config;
				try{curr_opcua_config = JSON.parse(this.responseText);}
				catch{break;}
				build_opcua_config_table(curr_opcua_config);
				request_mode = mode_enum.logstats;
				break;
			case mode_enum.logstats:
				try{curr_logstats = JSON.parse(this.responseText);}
				catch{break;}
				load_data_to_opcua_config_table(curr_logstats);
				if(curr_logstats.OPCUA_Config_xml_mod && !OPCUA_Config_xml_modified_flag)
					request_mode = mode_enum.opcua_config;
				OPCUA_Config_xml_modified_flag = curr_logstats.OPCUA_Config_xml_mod;
				break;
		}
		data_req=false;
	}
	else if(this.status == 404)
	{
		/*
		status_tab.value = "Error 404: Data Not found";
		status_tab.style.color='red';
		*/
		data_req=false;
	}
};
xhttp.ontimeout = function(){
	request_mode = mode_enum.opcua_config;
	data_req=false;
};
//Timer for get logstats
setInterval(get_data_req, 1000);
function get_data_req()
{
	if(!data_req)
	{
		switch(request_mode)
		{
			case mode_enum.opcua_config:
				xhttp.open("GET", "/morfeas_php/morfeas_web_if.php?COMMAND=opcua_config", true);
				xhttp.send();
				data_req = true;
				break;
			case mode_enum.logstats:
				xhttp.open("GET", "/morfeas_php/morfeas_web_if.php?COMMAND=logstats", true);
				xhttp.send();
				data_req = true;
				break;
		}
	}
}
iso_standard.request_isostandard();//Request ISOstandard from server.

/*
var tabledata = [
	{id:0, col:'red', iso_name:"TT001", type:"SDAQ", conn:"CAN0.ADDR:02.CH1", meas:10.55, graph:[25.66,55.99,21], desc:"a test", min:100, max:4000, cal_date:new Date()},
	{id:1, col:'orange', iso_name:"TT002", type:"SDAQ", conn:"CAN0.ADDR:02.CH2", meas:52.66, graph:[21.66,90.99], desc:"a test 2 ", min:100, max:4000},
	{id:2, col:'green', iso_name:"TT003", type:"SDAQ", conn:"CAN0.ADDR:02.CH3", meas:100.55, graph:[70.66,78.99], desc:"a test 3", min:100, max:4000}
];
*/
function build_opcua_config_table(curr_opcua_config)
{
	if(!curr_opcua_config)
		return;
	let tableData = [];
	for(let i=0; i<curr_opcua_config.length; i++)
	{
		let table_data_entry = {};
		table_data_entry.id=i;
		table_data_entry.iso_name=curr_opcua_config[i].ISO_CHANNEL;
		table_data_entry.type=curr_opcua_config[i].INTERFACE_TYPE;
		table_data_entry.desc=curr_opcua_config[i].DESCRIPTION;
		table_data_entry.min=curr_opcua_config[i].MIN;
		table_data_entry.max=curr_opcua_config[i].MAX;
		if(curr_opcua_config[i].hasOwnProperty('UNIT'))
			table_data_entry.unit=curr_opcua_config[i].UNIT;
		table_data_entry.anchor = curr_opcua_config[i].ANCHOR;
		table_data_entry.graph = new Array();
		tableData.push(table_data_entry);
	}
	opcua_config_table.setData(tableData);
}
function load_data_to_opcua_config_table(curr_logstats)
{
	if(!curr_logstats)
		return;
	let tableData = opcua_config_table.getData(),
		curr_logstats_com = morfeas_logstat_commonizer(curr_logstats);
	if(typeof(curr_logstats_com)==="object")
	{
		for(let i=0; i<tableData.length; i++)
		{
			let data = get_from_common_logstats_by_anchor(curr_logstats_com, tableData[i].type, tableData[i].anchor);
			if(!data)
			{
				tableData[i].col="red";
				tableData[i].conn="OFF-Line";
				tableData[i].meas = '-';
				tableData[i].status = '-';
				tableData[i].graph = [];
				continue;
			}
			tableData[i].conn = data.sensorUserId;
			if(data.unit)
				tableData[i].unit=data.unit;
			tableData[i].col=data.Is_meas_valid?'green':'yellow';
			tableData[i].status=data.Is_meas_valid?'Okay':data.Error_explanation;
			if(typeof(data.calibrationDate)==='number' && typeof(data.calibrationPeriod)=='number')
			{
				let cal_date = new Date(data.calibrationDate*1000),
					valid_until = new Date(cal_date.setMonth(cal_date.getMonth()+data.calibrationPeriod));
				if(new Date() >= valid_until)
				{
					tableData[i].col="orange";
					tableData[i].status = 'Cal no valid';
				}
				tableData[i].cal_date=valid_until;
			}
			else
				tableData[i].cal_date=null;
			if(typeof(data.avgMeasurement)==='number')//data.Is_meas_valid)
			{
				tableData[i].meas = data.avgMeasurement.toFixed(3)+' '+tableData[i].unit;
				if(tableData[i].graph.length>=GRAPH_LENGTH)
					tableData[i].graph.shift();
				tableData[i].graph.push(data.avgMeasurement.toFixed(1));
			}
			else
			{
				tableData[i].meas = '-';
				tableData[i].graph = [];
			}
		}
	}
	opcua_config_table.replaceData(tableData);
}
//@license-end
</script>
</html>
