<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link href="../External_components/tabulator/dist/css/tabulator_modern.min.css" rel="stylesheet">
<link rel="shortcut icon" type="image/x-icon" href="/art/Morfeas_logo_yellow.ico"/>
<title>Morfeas WEB ISOChannels Linker</title>
</head>
<body>
<div id="opcua_config_table"></div>
<footer id="footer">
	<div style="float:left;">
		Author: Sam Harry Tzavaras &#169; 12021-12022<br>
		<a href="../LICENSE">License: AGPLv3</a>
	</div>
</footer>
</body>
<script src="../External_components/jquery/dist/jquery.min.js"></script>
<script src="../External_components/sparkline/dist/jquery.sparkline.min.js"></script>
<script src="../External_components/tabulator/dist/js/tabulator.min.js"></script>
<script src='../morfeas_ecma/common.js'></script>
<script src='../morfeas_ecma/morfeas_web_if.js'></script>
<script>
//@license magnet:?xt=urn:btih:0b31508aeb0634b347b8270c7bee4d411b5d4109&dn=agpl-3.0.txt AGPL-v3.0
/*
@licstart  The following is the entire license notice for the
JavaScript code in this page.

Copyright (C) 12019-12021  Sam Harry Tzavaras

The JavaScript code in this page is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU AGPL) as published by the Free Software
Foundation, either version 3 of the License, or any later version.
The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.

@licend  The above is the entire license notice
for the JavaScript code in this page.
*/
"use strict";
comp_check();
const mode_enum = {
	opcua_config: 0,
	logstats: 1
};

//Global Vars.
var data_req=false, curr_opcua_config,
	request_mode = mode_enum.opcua_config;

var tabledata = [
	{id:0, iso_name:"TT001", type:"SDAQ", conn:"CAN0.ADDR:02.CH1", meas:10.55, graph:[25.66,55.99,21], desc:"a test", min:100, max:4000},
	{id:1, iso_name:"TT002", type:"SDAQ", conn:"CAN0.ADDR:02.CH2", meas:52.66, graph:[21.66,90.99], desc:"a test 2", min:100, max:4000},
	{id:2, iso_name:"TT003", type:"SDAQ", conn:"CAN0.ADDR:02.CH3", meas:100.55, graph:[70.66,78.99], desc:"a test 3", min:100, max:4000}
];
var lineFormatter = function(cell, formatterParams, onRendered){
    onRendered(function(){$(cell.getElement()).sparkline(cell.getValue(), {width:"100%", type:"line"})});
};
var opcua_config_table = new Tabulator("#opcua_config_table", {
 	height:"800px",
 	layout:"fitDataFill", //fit columns to width of table (optional)
 	responsiveLayout:"collapse",
	columns: //Define Table Columns
	[ 
	 	//{formatter:"responsiveCollapse", width:30, minWidth:30, hozAlign:"center", resizable:false, headerSort:false},
		{title:"ISOName", field:"iso_name"},
		{title:"Sensor type", field:"type"},
	 	{title:"Interface connection", field:"conn"},
	 	{title:"Current Value", field:"meas"},
	 	{title:"History", field:"graph", headerSort:false, formatter:lineFormatter},
		{title:"Description", field:"desc", responsive:0},
		{title:"Min", field:"min", responsive:0},
		{title:"Max", field:"max", responsive:0}
 	],
	data:tabledata, //assign data to table
 	/*
	rowClick:function(e, row){ //trigger an alert message when the row is clicked
 		alert("Row " + row.getData().id + " Clicked!!!!");
 	},
	*/
});

//AJAX response handler
var xhttp = new XMLHttpRequest();
xhttp.timeout = 2000;
xhttp.onreadystatechange = function()
{
	let status_tab=document.getElementById("status_tab");
	if (this.readyState == 4 && this.status == 200)
	{
		if(this.getResponseHeader("Content-Type")!=="application/json")
			return;
		switch(request_mode)
		{
			case mode_enum.opcua_config:
				curr_opcua_config = JSON.parse(this.responseText);
				request_mode = mode_enum.logstats;
				break;
			case mode_enum.logstats:
				let curr_logstats = morfeas_logstat_commonizer(this.responseText);
				//console.log(curr_logstats);
				break;
		}
		data_req=false;
	}
	else if(this.status == 404)
	{
		/*
		status_tab.value = "Error 404: Data Not found";
		status_tab.style.color='red';
		*/
		data_req=false;
	}
};
xhttp.ontimeout = function(){
	/*
	document.getElementById("status_tab").value = "Connection to server: Timeout Error";
	document.getElementById("status_tab").style.color='blue';
	*/
	data_req=false;
};
//timer for get logstats
setInterval(get_data_req, 1000);
function get_data_req()
{
	if(!data_req)
	{
		switch(request_mode)
		{
			case mode_enum.opcua_config:
				xhttp.open("GET", "/morfeas_php/morfeas_web_if.php?COMMAND=opcua_config", true);
				xhttp.send();
				data_req = true;
				break;
			case mode_enum.logstats:
				xhttp.open("GET", "/morfeas_php/morfeas_web_if.php?COMMAND=logstats", true);
				xhttp.send();
				data_req = true;
				break;
		}
	}
}
iso_standard.request_isostandard();//Request ISOstandard from server.
//@license-end
</script>
</html>