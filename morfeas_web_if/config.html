<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="shortcut icon" type="image/x-icon" href="rpi_logo.ico" />
<title>Raspberry Pi Controller Network</title>
<style>
td.bold {
    font-weight: bold;
}
input.global_style{
	width: 3em;
}
</style>
</head>
<body>
<table style="margin:auto">
  <tr>
    <th colspan="2">Ethernet Configuration</th>
  </tr>
  <tr>
    <td>Network IP</td>
    <td class="bold">192 : 168 : <input class="global_style" type="number" name="ip"> : <input class="global_style" type="number" name="ip"></td> 
  </tr>
  <tr>
    <td>Subnet Mask</td>
    <td class="bold">255 : 255 : <input class="global_style" type="number" name="mask"> : <input class="global_style" type="number" name="mask"></td> 
  </tr>
  <tr>
    <td>Default Gateway</td>
    <td class="bold">192 : 168 : <input class="global_style" type="number" name="gateway"> : <input class="global_style" type="number" name="gateway"></td> 
  </tr>
  <tr>
    <th colspan="2">ModBus TCP Configuration</th>
  </tr>
  <tr>
    <td>TCP Port</td>
    <td><input style="width: 5em;" id="modbus_port" type="number"> (default 502)</td>  
  </tr>
  <tr>
    <td>Address</td>
    <td><input style="width: 5em;"value="0...4" type="text" readonly></td>  
  </tr>
  <tr>
    <td>Max Connections</td>
    <td><input class="global_style" id="connections" type="number"> (default 5)</td>
  </tr>
  <tr>
    <td><input id="default" type="button" value="load Default" onclick="default_config()"></td>
    <td style="text-align: right;"><input id="Save" type="button" value="Save and Reboot" onclick="Send_to_rpi()"></td>
  </tr>
</table>

<script>
    //DOM vars
	var ip=document.getElementsByName("ip"),mask=document.getElementsByName("mask"),
	    gateway=document.getElementsByName("gateway"),connections=document.getElementById("connections"),
		modbus_port=document.getElementById("modbus_port"),modbus_add=0;//document.getElementById("modbus_add");
	//ajax object for configuration receive and send
	var config,fl,xhttp = new XMLHttpRequest();
	var Request = {
		  GET: 1,
		  POST: 0
		};
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			if(fl==Request.GET)//Get request
			{
				config = JSON.parse(xhttp.responseText);
				default_config();
			}
		}
	}; 
	//Get the configuration 
	fl=Request.GET;
	xhttp.open("GET", "config.json"+"?q="+makeid(), true);
	xhttp.send();
	function makeid()
	{
		var text = "";
		var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

		for( var i=0; i < 5; i++ )
			text += possible.charAt(Math.floor(Math.random() * possible.length));

		return text;
	}	
	function default_config()
	{
		//config min and max value to number input
		for(i=0;i<2;i++)
		{
			ip[i].max=255;ip[i].min=0;
			mask[i].max=255;mask[i].min=0;
			mask[i].max=255;mask[i].min=0;
			gateway[i].max=255;gateway[i].min=0;

			ip[i].value=config.eth_ip[i+2];
			mask[i].value=config.mask[i+2];
			gateway[i].value=config.gateway[i+2];
			if(i==1)
			{
				ip[i].min=1;
				gateway[i].min=1;
			}
		}
		connections.max="10";connections.min="1";
		modbus_add.min="5";modbus_add.max="255";
		modbus_port.max="65535";modbus_port.min="1";
		modbus_port.value=config.modbus_tcp_port;
		connections.value=config.max_con;
		//modbus_add.value=config.slave_add;
	}
	function Send_to_rpi()
	{
		const mask_val=[0,128,192,224,240,248,252,254,255];
		for(i=0;i<2;i++)
		{
			if((parseInt(ip[i].value)>parseInt(ip[i].max))
			 ||(parseInt(ip[i].value)<parseInt(ip[i].min))
			 ||(parseInt(gateway[i].value)>parseInt(gateway[i].max))
			 ||(parseInt(gateway[i].value)<parseInt(gateway[i].min))
			 ||!Number.isInteger(parseFloat(ip[i].value)))
			{
				alert("IP address or IP of default Gateway in not valid");
				return;
			}
			if((mask_val.indexOf(parseInt(mask[i].value))<0)
			 ||(parseInt(mask[1].value)>0&&parseInt(mask[0].value)!=255)
			 ||(parseInt(mask[1].value))==255)
			{
				alert("Subnet mask in not valid");
				return;
			}
		}
		if((parseInt(connections.value)>parseInt(connections.max))
		 ||(parseInt(connections.value)<parseInt(connections.min))
		 ||!Number.isInteger(parseFloat(connections.value)))
		{
			alert("Max connections number NOT Valid");
			return;				
		}
		/*if((parseInt(modbus_add.value)>parseInt(modbus_add.max))
		 ||(parseInt(modbus_add.value)<parseInt(modbus_add.min))
		 ||!Number.isInteger(parseFloat(modbus_add.value)))
		{
			alert("ModBus Address NOT in Range (6..255)");
			return;				
		}*/
		if((parseInt(modbus_port.value)>parseInt(modbus_port.max))
		 ||(parseInt(modbus_port.value)<parseInt(modbus_port.min))
		 || modbus_port.value==80||!Number.isInteger(parseFloat(modbus_port.value)))
		{
			alert("ModBus Port NOT in Range");
			return;				
		}
		//Send the configuration 
		fl=Request.POST;
		xhttp.open("POST", "config.php", true);
		xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhttp.send("IP_ADD=192.168."+ip[0].value+"."+ip[1].value+"&MASK=255.255."
					+mask[0].value+"."+mask[1].value+"&GATE=192.168."+gateway[0].value
					+"."+gateway[1].value+"&PORT="+modbus_port.value+"&MAX_CONN="+connections.value+"&ADD="+modbus_add);//.value
		alert("Rpi Save configuration and Rebooting");
	}
</script>
</body>
</html>